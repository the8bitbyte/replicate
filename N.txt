from flask import Flask, request, jsonify
import os

app = Flask(__name__)

# Dictionary to track IPs
ip_log = {}
counter_file = "counter.txt"

# Initialize counter
if not os.path.exists(counter_file):
    with open(counter_file, "w") as f:
        f.write("0")

def read_counter():
    with open(counter_file, "r") as f:
        return int(f.read())

def update_counter(value):
    with open(counter_file, "w") as f:
        f.write(str(value))

@app.route("/", methods=["POST"])
def log_ip():
    # Get real client IP from X-Forwarded-For
    client_ip = request.headers.get("X-Forwarded-For", request.remote_addr)

    if client_ip in ip_log:
        return "Blocked", 403

    ip_log[client_ip] = True
    counter = read_counter()
    counter += 1
    update_counter(counter)

    # Log IP and increment counter
    print(f"Logged IP: {client_ip}, Counter: {counter}")
    return "Logged", 200

@app.route("/counter", methods=["GET"])
def get_counter():
    counter = read_counter()
    return jsonify({"current_counter": counter})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
